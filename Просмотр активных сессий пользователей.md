
Отличный вопрос! Когда вы многократно входите под разными пользователями, создается "матрешка" из сессий. Вот как с этим работать.

## Просмотр активных сессий

### 1. **Просмотр текущей иерархии сессий в терминале**

bash

# Показать дерево процессов с именами пользователей
ps -ef f --forest | grep -A 5 -B 5 "bash\|zsh\|sh"

# Или более читаемый вариант:
pstree -pu

**Пример вывода:**

text

sshd(1234)───sshd(5678)───sshd(5690)───bash(5691,ivan)───sudo(5789)───bash(5790,root)───sudo(5820)───bash(5821,postgres)

Здесь видно: ivan → root → postgres

### 2. **Просмотр всех логинов в системе**

bash

# Показать все активные сессии
who
w

# Более подробная информация
last | head -20

**Пример вывода `who`:**

text

ivan     pts/0        2024-01-15 10:30 (192.168.1.100)
root     pts/1        2024-01-15 10:35 (192.168.1.100)

### 3. **Просмотр своих сессий изнутри**

bash

# Показать цепочку sudo сессий
sudo -V | grep "Session owner"

# Или посмотреть родительские процессы:
echo "Текущий пользователь: $(whoami)"
echo "Родительские процессы:"
ps -o pid,user,comm -p $$,$PPID,$(ps -o ppid= -p $PPID)

---

## Закрытие сессий

### Способ 1: **Последовательный выход (рекомендуется)**

Просто выполняйте `exit` или `Ctrl+D` пока не вернетесь к нужному уровню:

bash

postgres@server:~$ exit
root@server:~# exit
ivan@server:~$  # Вернулись к исходному пользователю

### Способ 2: **Прямой выход к конкретному пользователю**

Если вы глубоко в цепочке и хотите сразу выйти к определенному уровню:

bash

# Узнать PID вашей исходной оболочки
echo $PPID  # Покажет PID родительского процесса

# Или найти все ваши сессии:
ps -u $(whoami) -o pid,user,tty,comm | grep bash

### Способ 3: **Принудительное завершение сессий**

bash

# Завершить все сессии текущего пользователя (кроме текущей)
pkill -KILL -u $(whoami)

# Завершить сессии на определенном TTY
sudo pkill -9 -t pts/1

# Просмотреть какие сессии будут завершены:
ps -u $(whoami) -o pid,tty,comm

### Способ 4: **Закрытие SSH сессий**

bash

# Показать все SSH соединения
sudo netstat -tnpa | grep :22

# Или посмотреть логи SSH
sudo tail -f /var/log/auth.log | grep ssh

---

## Практические примеры

### Пример 1: Диагностика "матрешки" сессий

bash

# Создадим несколько уровней
ivan@server:~$ sudo -i
root@server:~# sudo -u postgres -i
postgres@server:~$

# Теперь диагностируем:
postgres@server:~$ ps -ef --forest | grep -A 3 -B 3 "bash"

### Пример 2: Сценарий для просмотра всей цепочки

Создайте скрипт `session_chain.sh`:

bash

#!/bin/bash
echo "=== Цепочка сессий ==="
current_pid=$$
while [ $current_pid -ne 1 ]; do
    ps -p $current_pid -o pid,user,comm --no-headers
    current_pid=$(ps -o ppid= -p $current_pid | tr -d ' ')
done

### Пример 3: Безопасный выход из всех сессий

bash

# Выйти из всех сессий кроме исходной
ivan@server:~$ sudo -i
root@server:~# sudo -u postgres -i
postgres@server:~$

# Теперь безопасный выход:
postgres@server:~$ exit  # вернуться к root
root@server:~# exit      # вернуться к ivan
ivan@server:~$           # исходная сессия

---

## Важные предупреждения

⚠️ **Осторожно с `pkill` и `killall`:**

bash

# НЕ ДЕЛАЙТЕ это в production!
sudo pkill -u username  # может убить критические процессы

# Вместо этого завершайте только shell-сессии:
sudo pkill -KILL -u username -t pts

⚠️ **Проверяйте что завершаете:**

bash

# Сначала посмотрите
ps -u username -o pid,tty,comm,args

# Потом завершайте

## Быстрая команда для повседневного использования

Добавьте в ваш `.bashrc` алиас:

bash

alias mysessions='ps -ef --forest | grep -A 2 -B 2 "$USER" | grep -E "bash|zsh|sh|su|sudo"'

Теперь просто вводите `mysessions` чтобы увидеть все ваши активные сессии.

**Рекомендация:** Всегда используйте последовательный `exit` — это самый безопасный способ не потерять важные процессы.